name: Sync content to openinframx

on:
  push:
    branches:
      - main
    paths:
      - 'content/openinfra/**'
      - 'static/images/blog/openinfra/**'
      - 'content/openinfradays/**'
      - 'static/images/blog/openinfradays/**'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout osslat
        uses: actions/checkout@v6
        with:
          path: osslat

      - name: Checkout openinframx
        uses: actions/checkout@v6
        with:
          repository: opensource-latinamerica/openinframx
          path: openinframx
          token: ${{ secrets.SYNC_PAT }}

      - name: Sync content
        run: |
          rsync -av osslat/content/openinfra/ openinframx/content/openinfra/
          rsync -av osslat/content/authors/ openinframx/content/authors/
          rsync -av osslat/static/images/blog/openinfra/ openinframx/static/images/blog/openinfra/
          rsync -av osslat/content/openinfradays/ openinframx/content/openinfradays/
          rsync -av osslat/static/images/blog/openinfradays/ openinframx/static/images/blog/openinfradays/

      - name: Commit and push changes
        run: |
          cd openinframx
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          if [[ -n $(git status -s) ]]; then
            git add .
            ORIGINAL_COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
            NEW_COMMIT_MESSAGE="repo(sync): $ORIGINAL_COMMIT_MESSAGE"
            git commit -m "$NEW_COMMIT_MESSAGE"
            git push
          else
            echo "No changes to sync."
          fi
